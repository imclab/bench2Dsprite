<body>
	<script src="vendor/requestanimationframe.js"></script>
	<script src="vendor/Stats.js"></script>
	<script src="../vendor/gowiththeflow.js"></script>

	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../vendor/excanvas.min.js"></script><![endif]-->
	<script language="javascript" type="text/javascript" src="../vendor/jquery.js"></script>
	<script language="javascript" type="text/javascript" src="../vendor/jquery.flot.js"></script>
	<script>
		function benchCanvas(nImages, nSeconds, callback){
			var canvas = document.createElement("canvas");  
			canvas.width	= 640;
			canvas.height	= 480;
			document.body.appendChild(canvas);

			var ctx		= canvas.getContext("2d");
			
			var image	= new Image();
			image.onload	= function(){
				start();
			};
			image.crossOrigin= '';
			image.src	= "logo128.png";			
	

			var timeStart, nFrame;

			function start(){
				timeStart	= Date.now();
				nFrame		= 0;
				requestAnimationFrame(anim);
			}
			function anim(){
				var deltaSeconds= (Date.now() - timeStart)/1000
				if( deltaSeconds > nSeconds && timeStart ){
					//console.log("nFrame", nFrame);
					//console.log("nImages", nImages);
					//console.log("deltaSeconds", deltaSeconds);
					var imagesRate	= (nFrame*nImages)/deltaSeconds;
					canvas.parentNode.removeChild(canvas);
					callback && callback(imagesRate, nFrame, nImages);
					return;
				}

				requestAnimationFrame(anim);

				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				var width	= ctx.canvas.width;
				var height	= ctx.canvas.height;
				
				var speed	= Date.now()/10;
				for(var i = 0; i < nImages; i++){
					var x	= Math.floor(speed+i)	% 640;
					var y	= Math.floor(speed+i)*3	% 480;
					ctx.drawImage(image, x, y)
				}
				nFrame++;
			}			
		}

		var params	= [
			{ nImages	: 5000,
			  nSeconds	: 5,
			},
			{ nImages	: 5000,
			  nSeconds	: 5,
			},
			{ nImages	: 5000,
			  nSeconds	: 5,
			},
		];
		var results	= [];

		var flow	= Flow();
		params.forEach(function(item, benchIdx){
			var nImages	= item.nImages;
			var nSeconds	= item.nSeconds;
			flow.seq(function(next){
				benchCanvas(nImages, nSeconds,function(imagesRate, nFrame, nImages){
					console.log("Results: imageRate", imagesRate, imagesRate/30)
					results[benchIdx]	= {
						imageRate	: imagesRate
					};
					next();
				});
			});			
		});
		flow.seq(function(){
			var graphDiv	= document.createElement("div");  
			graphDiv.style.width	= 640;
			graphDiv.style.height	= 300;
			document.body.appendChild(graphDiv);

			// build the points to draw
			var points	= [];
			results.forEach(function(result, idx){
				points.push([idx, result.imageRate/30]);
			});
			jQuery.plot(graphDiv, [{
				label	: "Canvas",
				bars	: { show: true },
				data	: points
			}]);
		});
	</script>
</body>